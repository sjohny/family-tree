<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Our Family Tree</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Lora:wght@400;500&family=Source+Sans+3:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #faf7f2; --bg-warm: #f5f0e8; --card: #ffffff;
  --text: #3a3028; --text-soft: #7a6f63; --text-muted: #a89e93;
  --accent: #8b7355; --accent-light: #c4a882; --accent-warm: #d4a574;
  --border: #e6ddd1; --border-light: #efe8de; --gold: #c9a96e;
  --shadow: rgba(60,48,30,0.08); --shadow-md: rgba(60,48,30,0.12);
  --line-color: #b8ad9e; --male: #7a92a8; --female: #b08a9a;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Source Sans 3',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
body::before { content:''; position:fixed; inset:0; background:radial-gradient(ellipse at 20% 20%,rgba(201,169,110,0.06) 0%,transparent 50%),radial-gradient(ellipse at 80% 80%,rgba(176,138,154,0.05) 0%,transparent 50%); pointer-events:none; z-index:0; }

/* Header */
.app-header { position:sticky; top:0; z-index:100; background:rgba(250,247,242,0.92); backdrop-filter:blur(20px); border-bottom:1px solid var(--border-light); padding:0 2rem; }
.header-inner { max-width:1400px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; height:64px; }
.header-title { font-family:'Playfair Display',serif; font-size:1.5rem; font-weight:600; cursor:pointer; }
.header-title span { color:var(--accent-warm); }
.header-actions { display:flex; gap:0.5rem; align-items:center; }

/* Buttons */
.btn { display:inline-flex; align-items:center; gap:0.4rem; padding:0.5rem 1rem; border:1px solid var(--border); border-radius:8px; background:var(--card); color:var(--text); font-family:'Source Sans 3',sans-serif; font-size:0.85rem; font-weight:500; cursor:pointer; transition:all 0.2s; white-space:nowrap; }
.btn:hover { border-color:var(--accent-light); box-shadow:0 2px 8px var(--shadow); }
.btn-primary { background:var(--accent); color:#fff; border-color:var(--accent); }
.btn-primary:hover { background:#7a6348; }
.btn-danger { color:#c0392b; border-color:#e8c4c0; }
.btn-danger:hover { background:#fdf0ef; border-color:#c0392b; }
.btn-sm { padding:0.35rem 0.75rem; font-size:0.8rem; }
.btn-icon { width:36px; height:36px; padding:0; display:inline-flex; align-items:center; justify-content:center; border-radius:8px; }

/* Tree Canvas */
.tree-container { position:relative; z-index:1; min-height:calc(100vh - 64px); overflow:auto; }
.tree-title-section { text-align:center; padding:2rem 0 1rem; }
.tree-title-section h1 { font-family:'Playfair Display',serif; font-size:2.2rem; font-weight:600; }
.tree-title-section .subtitle { font-family:'Lora',serif; font-size:0.95rem; color:var(--text-muted); font-style:italic; }

/* Tree absolute-positioned canvas */
#treeCanvas { position:relative; margin:0 auto; }
#treeSvg { position:absolute; top:0; left:0; pointer-events:none; z-index:0; }
#treeSvg line { stroke:var(--line-color); stroke-width:1.8; stroke-linecap:round; }

/* Member card (absolutely positioned) */
.tree-node { position:absolute; display:flex; flex-direction:column; align-items:center; gap:4px; cursor:pointer; transition:transform 0.2s; z-index:1; }
.tree-node:hover { transform:translateY(-3px); }
.tree-node .photo { width:76px; height:76px; border-radius:50%; border:3px solid var(--border); overflow:hidden; background:var(--bg-warm); display:flex; align-items:center; justify-content:center; box-shadow:0 3px 12px var(--shadow); transition:all 0.3s; }
.tree-node:hover .photo { border-color:var(--accent-light); box-shadow:0 6px 20px var(--shadow-md); }
.tree-node .photo img { width:100%; height:100%; object-fit:cover; }
.tree-node .photo .initials { font-family:'Playfair Display',serif; font-size:1.3rem; font-weight:500; color:var(--text-muted); }
.tree-node .photo.male { border-color:var(--male); }
.tree-node .photo.female { border-color:var(--female); }
.tree-node .name { font-family:'Lora',serif; font-size:0.78rem; font-weight:500; text-align:center; line-height:1.2; max-width:100px; }
.tree-node .dates { font-size:0.68rem; color:var(--text-muted); text-align:center; }
.tree-node .maiden { font-size:0.68rem; color:var(--text-soft); font-style:italic; }

/* Generation labels */
.gen-label-abs { position:absolute; font-family:'Lora',serif; font-size:0.65rem; text-transform:uppercase; letter-spacing:0.12em; color:var(--text-muted); z-index:2; white-space:nowrap; }

/* Empty state */
.empty-state { text-align:center; padding:4rem 2rem; max-width:500px; margin:0 auto; }
.empty-state .tree-icon { font-size:4rem; margin-bottom:1.5rem; opacity:0.5; }
.empty-state h2 { font-family:'Playfair Display',serif; font-size:1.6rem; font-weight:500; margin-bottom:0.75rem; }
.empty-state p { color:var(--text-soft); font-size:0.95rem; margin-bottom:1.5rem; line-height:1.6; }

/* Modal */
.modal-overlay { position:fixed; inset:0; background:rgba(58,48,40,0.4); backdrop-filter:blur(4px); z-index:1000; display:flex; align-items:center; justify-content:center; padding:1rem; opacity:0; visibility:hidden; transition:all 0.3s; }
.modal-overlay.active { opacity:1; visibility:visible; }
.modal { background:var(--card); border-radius:16px; box-shadow:0 20px 60px rgba(58,48,40,0.25); width:100%; max-width:520px; max-height:90vh; overflow-y:auto; transform:translateY(20px); transition:transform 0.3s; }
.modal-overlay.active .modal { transform:translateY(0); }
.modal-header { padding:1.5rem 1.5rem 0; display:flex; align-items:center; justify-content:space-between; }
.modal-header h2 { font-family:'Playfair Display',serif; font-size:1.3rem; font-weight:600; }
.modal-body { padding:1.25rem 1.5rem 1.5rem; }
.modal-footer { padding:0 1.5rem 1.5rem; display:flex; gap:0.5rem; justify-content:flex-end; }

/* Form */
.form-row { display:flex; gap:0.75rem; margin-bottom:0.75rem; }
.form-group { flex:1; margin-bottom:0.75rem; }
.form-row .form-group { margin-bottom:0; }
.form-group label { display:block; font-size:0.78rem; font-weight:500; color:var(--text-soft); margin-bottom:0.3rem; text-transform:uppercase; letter-spacing:0.05em; }
.form-group input,.form-group select,.form-group textarea { width:100%; padding:0.6rem 0.8rem; border:1px solid var(--border); border-radius:8px; font-family:'Source Sans 3',sans-serif; font-size:0.9rem; color:var(--text); background:var(--bg); transition:border-color 0.2s; }
.form-group input:focus,.form-group select:focus,.form-group textarea:focus { outline:none; border-color:var(--accent-light); box-shadow:0 0 0 3px rgba(196,168,130,0.15); }
.form-group textarea { resize:vertical; min-height:60px; }
.form-group .help-text { font-size:0.72rem; color:var(--text-muted); margin-top:0.25rem; }
.photo-preview-row { display:flex; gap:0.75rem; align-items:flex-end; }
.photo-preview-row .form-group { flex:1; }
.photo-preview { width:56px; height:56px; border-radius:50%; border:2px solid var(--border); overflow:hidden; background:var(--bg-warm); flex-shrink:0; display:flex; align-items:center; justify-content:center; }
.photo-preview img { width:100%; height:100%; object-fit:cover; }
.photo-preview .preview-placeholder { font-size:0.65rem; color:var(--text-muted); text-align:center; }

/* Detail Panel */
.detail-panel { position:fixed; right:-420px; top:64px; width:400px; height:calc(100vh - 64px); background:var(--card); border-left:1px solid var(--border); box-shadow:-4px 0 20px var(--shadow); z-index:200; transition:right 0.35s cubic-bezier(0.4,0,0.2,1); overflow-y:auto; padding:1.5rem; }
.detail-panel.open { right:0; }
.detail-panel-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:1.5rem; }
.detail-photo { width:100px; height:100px; border-radius:50%; border:3px solid var(--border); overflow:hidden; background:var(--bg-warm); margin:0 auto 1rem; display:flex; align-items:center; justify-content:center; }
.detail-photo img { width:100%; height:100%; object-fit:cover; }
.detail-photo .initials { font-family:'Playfair Display',serif; font-size:2rem; color:var(--text-muted); }
.detail-name { font-family:'Playfair Display',serif; font-size:1.4rem; text-align:center; margin-bottom:0.25rem; }
.detail-maiden { text-align:center; font-style:italic; color:var(--text-soft); font-size:0.9rem; margin-bottom:0.5rem; }
.detail-dates { text-align:center; color:var(--text-muted); font-size:0.85rem; margin-bottom:1rem; }
.detail-bio { color:var(--text-soft); font-size:0.9rem; line-height:1.6; padding:1rem; background:var(--bg); border-radius:8px; margin-bottom:1rem; }
.detail-relations { margin-top:1rem; }
.detail-relations h4 { font-family:'Lora',serif; font-size:0.85rem; font-weight:500; color:var(--text-soft); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:0.5rem; }
.detail-rel-item { display:flex; align-items:center; gap:0.5rem; padding:0.5rem 0; cursor:pointer; }
.detail-rel-item:hover { color:var(--accent); }
.detail-rel-item .mini-photo { width:32px; height:32px; border-radius:50%; border:2px solid var(--border); overflow:hidden; background:var(--bg-warm); display:flex; align-items:center; justify-content:center; flex-shrink:0; }
.detail-rel-item .mini-photo img { width:100%; height:100%; object-fit:cover; }
.detail-rel-item .mini-photo .initials { font-size:0.6rem; color:var(--text-muted); }
.detail-actions { display:flex; gap:0.5rem; margin-top:1.5rem; padding-top:1rem; border-top:1px solid var(--border-light); }

/* Dropdown */
.dropdown { position:relative; }
.dropdown-menu { position:absolute; top:100%; right:0; margin-top:4px; background:var(--card); border:1px solid var(--border); border-radius:10px; box-shadow:0 8px 24px var(--shadow-md); min-width:180px; z-index:300; overflow:hidden; display:none; }
.dropdown-menu.show { display:block; }
.dropdown-menu button { display:flex; align-items:center; gap:0.5rem; width:100%; padding:0.65rem 1rem; border:none; background:none; font-family:'Source Sans 3',sans-serif; font-size:0.85rem; color:var(--text); cursor:pointer; text-align:left; }
.dropdown-menu button:hover { background:var(--bg-warm); }
.dropdown-menu hr { border:none; border-top:1px solid var(--border-light); margin:0; }

/* Toast */
.toast { position:fixed; bottom:2rem; left:50%; transform:translateX(-50%) translateY(80px); background:var(--text); color:#fff; padding:0.75rem 1.25rem; border-radius:10px; font-size:0.85rem; z-index:2000; transition:transform 0.3s; box-shadow:0 8px 24px rgba(0,0,0,0.2); }
.toast.show { transform:translateX(-50%) translateY(0); }

@media (max-width:768px) {
  .header-title { font-size:1.2rem; }
  .tree-title-section h1 { font-size:1.8rem; }
  .detail-panel { width:100%; right:-100%; }
  .tree-node .photo { width:60px; height:60px; }
  .tree-node .name { font-size:0.7rem; }
}
::-webkit-scrollbar { width:8px; }
::-webkit-scrollbar-track { background:var(--bg); }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:4px; }
</style>
</head>
<body>

<header class="app-header">
  <div class="header-inner">
    <div class="header-title" onclick="closeDetailPanel()">Family<span>Tree</span></div>
    <div class="header-actions">
      <button class="btn btn-primary" onclick="openAddMember()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add Person
      </button>
      <button class="btn" onclick="openRelationshipModal()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4-4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
        Add Relation
      </button>
      <div class="dropdown">
        <button class="btn btn-icon" onclick="toggleMenu()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
        </button>
        <div class="dropdown-menu" id="dropdownMenu">
          <button onclick="openSettings()">âš™ï¸ Settings</button>
          <button onclick="exportData()">ğŸ“ Export Data</button>
          <button onclick="document.getElementById('importInput').click()">ğŸ“¥ Import Data</button>
          <hr>
          <button onclick="loadSampleData()">ğŸŒ³ Load Sample Tree</button>
        </div>
      </div>
      <input type="file" id="importInput" accept=".json" style="display:none" onchange="importData(event)">
    </div>
  </div>
</header>

<div class="tree-container" id="treeContainer">
  <div class="tree-title-section">
    <h1 id="treeTitle">Our Family Tree</h1>
    <div class="subtitle" id="treeSubtitle"></div>
  </div>
  <div id="treeCanvas"></div>
</div>

<div class="detail-panel" id="detailPanel">
  <div class="detail-panel-header"><div></div>
    <button class="btn btn-icon btn-sm" onclick="closeDetailPanel()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
  <div id="detailContent"></div>
</div>

<div class="modal-overlay" id="memberModal">
  <div class="modal">
    <div class="modal-header">
      <h2 id="memberModalTitle">Add Family Member</h2>
      <button class="btn btn-icon btn-sm" onclick="closeMemberModal()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="memberId">
      <div class="form-row">
        <div class="form-group"><label>First Name</label><input type="text" id="firstName" placeholder="e.g. John"></div>
        <div class="form-group"><label>Last Name</label><input type="text" id="lastName" placeholder="e.g. Smith"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Maiden Name</label><input type="text" id="maidenName" placeholder="Optional"></div>
        <div class="form-group"><label>Gender</label><select id="gender"><option value="male">Male</option><option value="female">Female</option><option value="unknown">Other</option></select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Birth Date</label><input type="date" id="birthDate"></div>
        <div class="form-group"><label>Death Date</label><input type="date" id="deathDate"></div>
      </div>
      <div class="photo-preview-row">
        <div class="form-group"><label>Photo URL</label><input type="url" id="photoUrl" placeholder="Immich / pCloud / direct URL" oninput="updatePhotoPreview()"><div class="help-text">Immich shared links, pCloud public links, or direct image URLs</div></div>
        <div class="photo-preview" id="photoPreview"><span class="preview-placeholder">No photo</span></div>
      </div>
      <div class="form-group"><label>Bio / Notes</label><textarea id="bio" placeholder="A short biography..."></textarea></div>
    </div>
    <div class="modal-footer"><button class="btn" onclick="closeMemberModal()">Cancel</button><button class="btn btn-primary" onclick="saveMember()">Save</button></div>
  </div>
</div>

<div class="modal-overlay" id="relModal">
  <div class="modal">
    <div class="modal-header"><h2>Add Relationship</h2><button class="btn btn-icon btn-sm" onclick="closeRelModal()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div class="modal-body">
      <div class="form-group"><label>Relationship Type</label><select id="relType" onchange="updateRelLabels()"><option value="parent-child">Parent â†’ Child</option><option value="spouse">Spouse / Partner</option></select></div>
      <div class="form-group"><label id="relPerson1Label">Parent</label><select id="relPerson1"></select></div>
      <div class="form-group"><label id="relPerson2Label">Child</label><select id="relPerson2"></select></div>
    </div>
    <div class="modal-footer"><button class="btn" onclick="closeRelModal()">Cancel</button><button class="btn btn-primary" onclick="saveRelationship()">Add Relationship</button></div>
  </div>
</div>

<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <div class="modal-header"><h2>Settings</h2><button class="btn btn-icon btn-sm" onclick="closeSettings()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div class="modal-body">
      <div class="form-group"><label>Tree Title</label><input type="text" id="settingsTitle" placeholder="Our Family Tree"></div>
      <div class="form-group"><label>Subtitle</label><input type="text" id="settingsSubtitle" placeholder="Description..."></div>
    </div>
    <div class="modal-footer"><button class="btn" onclick="closeSettings()">Cancel</button><button class="btn btn-primary" onclick="saveSettings()">Save</button></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let familyData = { members:[], relationships:[], settings:{ title:'Our Family Tree', subtitle:'' } };
let selectedMemberId = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function api(method, path, body) {
  const opts = { method, headers: { "Content-Type": "application/json" } };
  if (body) opts.body = JSON.stringify(body);

  const res = await fetch("/api" + path, opts);

  if (!res.ok) {
    const txt = await res.text().catch(() => "");
    throw new Error(`${method} /api${path} failed: ${res.status} ${res.statusText} ${txt}`.slice(0, 300));
  }

  return res.json();
}

async function loadFamily() {
  try {
    familyData = await api("GET", "/family");
    if (!familyData.settings) familyData.settings = { title: "Our Family Tree", subtitle: "" };
    renderTree();
    updateTitle();
  } catch (e) {
    console.error(e);
    showToast("Failed to load data (check console)");
    familyData = { members: [], relationships: [], settings: { title: "Our Family Tree", subtitle: "" } };
    renderTree();
    updateTitle();
  }
}
function updateTitle() {
  document.getElementById('treeTitle').textContent = familyData.settings.title || 'Our Family Tree';
  document.getElementById('treeSubtitle').textContent = familyData.settings.subtitle || (familyData.members.length===0 ? 'Click "Add Person" to start building your family tree' : '');
  document.title = familyData.settings.title || 'Our Family Tree';
}
function showToast(msg) { const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }
function toggleMenu() { document.getElementById('dropdownMenu').classList.toggle('show'); }
document.addEventListener('click',e=>{ if(!e.target.closest('.dropdown')) document.getElementById('dropdownMenu').classList.remove('show'); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PHOTO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resolvePhotoUrl(url) { return url ? '/api/photo?url='+encodeURIComponent(url) : ''; }
function updatePhotoPreview() {
  const url=document.getElementById('photoUrl').value.trim(), p=document.getElementById('photoPreview');
  p.innerHTML = url ? `<img src="${resolvePhotoUrl(url)}" onerror="this.parentElement.innerHTML='<span class=\\'preview-placeholder\\'>Error</span>'">` : '<span class="preview-placeholder">No photo</span>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MEMBER CRUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAddMember() {
  document.getElementById('memberModalTitle').textContent='Add Family Member';
  ['memberId','firstName','lastName','maidenName','birthDate','deathDate','photoUrl','bio'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('gender').value='male'; updatePhotoPreview();
  document.getElementById('memberModal').classList.add('active');
  setTimeout(()=>document.getElementById('firstName').focus(),100);
}
function openEditMember(id) {
  const m=familyData.members.find(x=>x.id===id); if(!m) return;
  document.getElementById('memberModalTitle').textContent='Edit '+m.firstName;
  document.getElementById('memberId').value=m.id;
  ['firstName','lastName','maidenName','gender','birthDate','deathDate','photoUrl','bio'].forEach(f=>document.getElementById(f).value=m[f]||'');
  updatePhotoPreview(); document.getElementById('memberModal').classList.add('active');
}
function closeMemberModal() { document.getElementById('memberModal').classList.remove('active'); }
async function saveMember() {
  const id=document.getElementById('memberId').value;
  const d={firstName:document.getElementById('firstName').value.trim(),lastName:document.getElementById('lastName').value.trim(),maidenName:document.getElementById('maidenName').value.trim(),gender:document.getElementById('gender').value,birthDate:document.getElementById('birthDate').value,deathDate:document.getElementById('deathDate').value,photoUrl:document.getElementById('photoUrl').value.trim(),bio:document.getElementById('bio').value.trim()};
  if(!d.firstName){showToast('First name required');return;}
  if(id){await api('PUT','/members/'+id,d);showToast(d.firstName+' updated');}
  else{await api('POST','/members',d);showToast(d.firstName+' added');}
  closeMemberModal(); await loadFamily(); if(id&&selectedMemberId===id) showDetail(id);
}
async function deleteMember(id) {
  const m=familyData.members.find(x=>x.id===id);
  if(!m||!confirm(`Remove ${m.firstName} ${m.lastName}?`)) return;
  await api('DELETE','/members/'+id); closeDetailPanel(); showToast(m.firstName+' removed'); await loadFamily();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RELATIONSHIP CRUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openRelationshipModal() {
  if(familyData.members.length<2){showToast('Add at least 2 people first');return;}
  const o=familyData.members.map(m=>`<option value="${m.id}">${m.firstName} ${m.lastName}</option>`).join('');
  document.getElementById('relPerson1').innerHTML=o; document.getElementById('relPerson2').innerHTML=o;
  if(familyData.members.length>1) document.getElementById('relPerson2').selectedIndex=1;
  updateRelLabels(); document.getElementById('relModal').classList.add('active');
}
function updateRelLabels() { const t=document.getElementById('relType').value; document.getElementById('relPerson1Label').textContent=t==='parent-child'?'Parent':'Person 1'; document.getElementById('relPerson2Label').textContent=t==='parent-child'?'Child':'Person 2'; }
function closeRelModal() { document.getElementById('relModal').classList.remove('active'); }
async function saveRelationship() {
  const p1=document.getElementById('relPerson1').value,p2=document.getElementById('relPerson2').value;
  if(p1===p2){showToast('Select two different people');return;}
  const r=await api('POST','/relationships',{type:document.getElementById('relType').value,person1:p1,person2:p2});
  if(r.error){showToast(r.error);return;} closeRelModal(); showToast('Relationship added'); await loadFamily();
}
async function deleteRelationship(rid) { await api('DELETE','/relationships/'+rid); showToast('Removed'); await loadFamily(); if(selectedMemberId) showDetail(selectedMemberId); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS / EXPORT / IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSettings() { document.getElementById('settingsTitle').value=familyData.settings.title||''; document.getElementById('settingsSubtitle').value=familyData.settings.subtitle||''; document.getElementById('settingsModal').classList.add('active'); document.getElementById('dropdownMenu').classList.remove('show'); }
function closeSettings() { document.getElementById('settingsModal').classList.remove('active'); }
async function saveSettings() { const s={title:document.getElementById('settingsTitle').value.trim()||'Our Family Tree',subtitle:document.getElementById('settingsSubtitle').value.trim()}; await api('PUT','/settings',s); familyData.settings=s; updateTitle(); closeSettings(); showToast('Saved'); }
function exportData() { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(familyData,null,2)],{type:'application/json'})); a.download='family-tree-export.json'; a.click(); document.getElementById('dropdownMenu').classList.remove('show'); showToast('Exported'); }
async function importData(e) { const f=e.target.files[0]; if(!f) return; try{const d=JSON.parse(await f.text()); if(!d.members||!d.relationships) throw 0; await api('POST','/import',d); showToast('Imported'); await loadFamily();}catch{showToast('Invalid file');} e.target.value=''; document.getElementById('dropdownMenu').classList.remove('show'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DETAIL PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showDetail(id) {
  selectedMemberId=id; const m=familyData.members.find(x=>x.id===id); if(!m) return;
  const ini=(m.firstName[0]||'')+(m.lastName[0]||'');
  const ph=m.photoUrl?`<img src="${resolvePhotoUrl(m.photoUrl)}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">`:'';
  const iH=`<span class="initials" ${m.photoUrl?'style="display:none"':''}>${ini}</span>`;
  const sp=familyData.relationships.filter(r=>r.type==='spouse'&&(r.person1===id||r.person2===id)).map(r=>({rel:r,member:familyData.members.find(x=>x.id===(r.person1===id?r.person2:r.person1))})).filter(x=>x.member);
  const pa=familyData.relationships.filter(r=>r.type==='parent-child'&&r.person2===id).map(r=>({rel:r,member:familyData.members.find(x=>x.id===r.person1)})).filter(x=>x.member);
  const ch=familyData.relationships.filter(r=>r.type==='parent-child'&&r.person1===id).map(r=>({rel:r,member:familyData.members.find(x=>x.id===r.person2)})).filter(x=>x.member);
  const si=findSiblings(id);
  function rl(label,items){if(!items.length) return '';return `<div class="detail-relations"><h4>${label}</h4>${items.map(x=>{const i=(x.member.firstName[0]||'')+(x.member.lastName[0]||'');const p=x.member.photoUrl?`<img src="${resolvePhotoUrl(x.member.photoUrl)}" onerror="this.style.display='none'">`:`<span class="initials">${i}</span>`;const d=x.rel.id!=='sibling'?`<button class="btn btn-sm btn-danger" style="margin-left:auto;padding:2px 6px;font-size:0.7rem" onclick="event.stopPropagation();deleteRelationship('${x.rel.id}')">âœ•</button>`:'';return `<div class="detail-rel-item" onclick="showDetail('${x.member.id}')"><div class="mini-photo">${p}</div><span>${x.member.firstName} ${x.member.lastName}</span>${d}</div>`;}).join('')}</div>`;}
  const dates=[]; if(m.birthDate) dates.push('b. '+formatDate(m.birthDate)); if(m.deathDate) dates.push('d. '+formatDate(m.deathDate));
  document.getElementById('detailContent').innerHTML=`<div class="detail-photo ${m.gender}">${ph}${iH}</div><div class="detail-name">${m.firstName} ${m.lastName}</div>${m.maidenName?`<div class="detail-maiden">nÃ©e ${m.maidenName}</div>`:''}${dates.length?`<div class="detail-dates">${dates.join(' â€” ')}</div>`:''}${m.bio?`<div class="detail-bio">${m.bio}</div>`:''}${rl('Spouse / Partner',sp)}${rl('Parents',pa)}${rl('Children',ch)}${rl('Siblings',si)}<div class="detail-actions"><button class="btn" onclick="openEditMember('${m.id}')">âœï¸ Edit</button><button class="btn btn-danger" onclick="deleteMember('${m.id}')">ğŸ—‘ Delete</button></div>`;
  document.getElementById('detailPanel').classList.add('open');
}
function closeDetailPanel() { document.getElementById('detailPanel').classList.remove('open'); selectedMemberId=null; }
function findSiblings(id) {
  const pids=familyData.relationships.filter(r=>r.type==='parent-child'&&r.person2===id).map(r=>r.person1);
  if(!pids.length) return []; const s=new Set();
  pids.forEach(pid=>familyData.relationships.filter(r=>r.type==='parent-child'&&r.person1===pid&&r.person2!==id).forEach(r=>s.add(r.person2)));
  return [...s].map(sid=>({rel:{id:'sibling'},member:familyData.members.find(x=>x.id===sid)})).filter(x=>x.member);
}
function formatDate(d) { return d ? new Date(d+'T00:00:00').toLocaleDateString('en-US',{year:'numeric',month:'short',day:'numeric'}) : ''; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TREE LAYOUT ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CARD_W = 110;   // card width
const CARD_H = 130;   // card height (photo + name + dates)
const COUPLE_GAP = 16; // gap between spouses
const SIBLING_GAP = 40; // gap between sibling family units
const GEN_GAP = 70;    // vertical gap between generations
const PADDING = 40;

function renderTree() {
  const canvas = document.getElementById('treeCanvas');
  if (familyData.members.length === 0) {
    canvas.innerHTML = `<div class="empty-state"><div class="tree-icon">ğŸŒ³</div><h2>Start Your Family Tree</h2><p>Add your first family member to begin.</p><button class="btn btn-primary" onclick="openAddMember()">+ Add First Person</button></div>`;
    return;
  }

  const { nodes, lines, width, height, genLabels } = layoutTree();

  let html = `<svg id="treeSvg" width="${width}" height="${height}" style="width:${width}px;height:${height}px;">`;
  lines.forEach(l => { html += `<line x1="${l.x1}" y1="${l.y1}" x2="${l.x2}" y2="${l.y2}"/>`; });
  html += '</svg>';

  nodes.forEach(n => {
    const m = familyData.members.find(x => x.id === n.id);
    if (!m) return;
    html += makeNodeHtml(m, n.x, n.y);
  });

  genLabels.forEach(gl => {
    html += `<div class="gen-label-abs" style="left:${gl.x}px;top:${gl.y}px;">${gl.text}</div>`;
  });

  canvas.style.width = width + 'px';
  canvas.style.height = height + 'px';
  canvas.style.position = 'relative';
  canvas.innerHTML = html;
}

function makeNodeHtml(m, x, y) {
  const ini = (m.firstName[0]||'')+(m.lastName[0]||'');
  const ph = m.photoUrl ? `<img src="${resolvePhotoUrl(m.photoUrl)}" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">` : '';
  const iS = `<span class="initials" ${m.photoUrl?'style="display:none"':''}>${ini}</span>`;
  const yrs = [];
  if (m.birthDate) yrs.push(new Date(m.birthDate+'T00:00:00').getFullYear());
  if (m.deathDate) yrs.push(new Date(m.deathDate+'T00:00:00').getFullYear());
  return `<div class="tree-node" style="left:${x}px;top:${y}px;width:${CARD_W}px;" onclick="showDetail('${m.id}')">
    <div class="photo ${m.gender}">${ph}${iS}</div>
    <div class="name">${m.firstName} ${m.lastName}</div>
    ${m.maidenName?`<div class="maiden">nÃ©e ${m.maidenName}</div>`:''}
    ${yrs.length?`<div class="dates">${yrs.join(' â€“ ')}</div>`:''}
  </div>`;
}

function layoutTree() {
  const rels = familyData.relationships;
  const members = familyData.members;
  const pcRels = rels.filter(r => r.type === 'parent-child');
  const spRels = rels.filter(r => r.type === 'spouse');

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  GENERATION (ROW) ASSIGNMENT â€” robust
  //  Rules:
  //   - spouse => same generation
  //   - parent-child => child = max(child, parent+1)
  //   - iterate until stable
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const depth = {};
  members.forEach(m => depth[m.id] = 0);

  const MAX_ITERS = members.length * 5;

  for (let i = 0; i < MAX_ITERS; i++) {
    let changed = false;

    // spouses same generation (use max to pull up)
    spRels.forEach(r => {
      const a = r.person1, b = r.person2;
      const mx = Math.max(depth[a] ?? 0, depth[b] ?? 0);
      if (depth[a] !== mx) { depth[a] = mx; changed = true; }
      if (depth[b] !== mx) { depth[b] = mx; changed = true; }
    });

    // children below parents
    pcRels.forEach(r => {
      const p = r.person1, c = r.person2;
      const want = (depth[p] ?? 0) + 1;
      if ((depth[c] ?? 0) < want) { depth[c] = want; changed = true; }
    });

    if (!changed) break;
  }

  // normalize so min depth becomes 0
  const minD = Math.min(...Object.values(depth));
  Object.keys(depth).forEach(id => depth[id] -= minD);

  const maxD = Math.max(...Object.values(depth));

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  BUILD COUPLE/SINGLE UNITS PER GENERATION
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const spousesOf = {};
  spRels.forEach(r => {
    (spousesOf[r.person1] = spousesOf[r.person1] || []).push(r.person2);
    (spousesOf[r.person2] = spousesOf[r.person2] || []).push(r.person1);
  });

  // unitKey = "a|b" for spouse couple (sorted), or "a" for single
  const personToUnitKey = {};
  const unitKeyToMembers = {};
  const used = new Set();

  // create units generation-by-generation so couples form only inside same gen
  for (let d = 0; d <= maxD; d++) {
    const gm = members.filter(m => depth[m.id] === d);
    gm.forEach(m => {
      if (used.has(m.id)) return;

      const spouseId = (spousesOf[m.id] || []).find(sid => {
        if (used.has(sid)) return false;
        return depth[sid] === d; // only pair within same gen
      });

      if (spouseId) {
        const a = [m.id, spouseId].sort();
        const key = a.join('|');
        used.add(m.id); used.add(spouseId);
        unitKeyToMembers[key] = a;
        personToUnitKey[m.id] = key;
        personToUnitKey[spouseId] = key;
      } else {
        const key = m.id;
        used.add(m.id);
        unitKeyToMembers[key] = [m.id];
        personToUnitKey[m.id] = key;
      }
    });
  }

  // group unit keys by generation
  const unitsByGen = Array.from({ length: maxD + 1 }, () => []);
  Object.entries(unitKeyToMembers).forEach(([key, ids]) => {
    // generation of unit = generation of its first member (same for couple)
    const d = depth[ids[0]] ?? 0;
    unitsByGen[d].push(key);
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  ORDERING: traverse from root units -> children units
  //  so rows appear like you described
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const childrenOf = {};
  const parentsOf = {};
  pcRels.forEach(r => {
    (childrenOf[r.person1] = childrenOf[r.person1] || []).push(r.person2);
    (parentsOf[r.person2] = parentsOf[r.person2] || []).push(r.person1);
  });

  // unit graph: parentUnit -> childUnit
  const unitChildren = {};
  const unitParents = {};
  Object.keys(unitKeyToMembers).forEach(k => { unitChildren[k] = new Set(); unitParents[k] = new Set(); });

  pcRels.forEach(r => {
    const pu = personToUnitKey[r.person1];
    const cu = personToUnitKey[r.person2];
    if (!pu || !cu || pu === cu) return;
    unitChildren[pu].add(cu);
    unitParents[cu].add(pu);
  });

  const orderedUnitsByGen = Array.from({ length: maxD + 1 }, () => []);

  // root units = no unitParents AND has children (or you can keep all)
  const rootUnits = unitsByGen[0]
    .filter(u => unitParents[u].size === 0)
    .sort((u1, u2) => {
      // stable readable sorting by name as fallback
      const a1 = unitKeyToMembers[u1][0], a2 = unitKeyToMembers[u2][0];
      const m1 = members.find(x => x.id === a1), m2 = members.find(x => x.id === a2);
      const s1 = `${m1?.lastName||''} ${m1?.firstName||''}`.toLowerCase();
      const s2 = `${m2?.lastName||''} ${m2?.firstName||''}`.toLowerCase();
      return s1.localeCompare(s2);
    });

  const seenUnit = new Set();

  // seed gen0
  rootUnits.forEach(u => { orderedUnitsByGen[0].push(u); seenUnit.add(u); });

  // include any remaining gen0 units (disconnected) after roots
  unitsByGen[0].forEach(u => {
    if (!seenUnit.has(u)) { orderedUnitsByGen[0].push(u); seenUnit.add(u); }
  });

  // propagate order downward
  for (let d = 0; d < maxD; d++) {
    // ensure current gen has all units
    unitsByGen[d].forEach(u => {
      if (!orderedUnitsByGen[d].includes(u)) orderedUnitsByGen[d].push(u);
    });

    const next = [];
    orderedUnitsByGen[d].forEach(u => {
      [...unitChildren[u]].forEach(cu => {
        if ((depth[unitKeyToMembers[cu][0]] ?? 0) === d + 1 && !next.includes(cu)) {
          next.push(cu);
        }
      });
    });

    // add leftover units in next gen
    unitsByGen[d + 1].forEach(u => { if (!next.includes(u)) next.push(u); });
    orderedUnitsByGen[d + 1] = next;
  }

  // finally build gens = [{depth, units:[ [memberObj...], ... ]}]
  const gens = [];
  for (let d = 0; d <= maxD; d++) {
    const orderedKeys = orderedUnitsByGen[d].length ? orderedUnitsByGen[d] : unitsByGen[d];
    const units = orderedKeys
      .filter(k => (unitKeyToMembers[k] || []).length)
      .map(k => unitKeyToMembers[k].map(id => members.find(m => m.id === id)).filter(Boolean));
    if (units.length) gens.push({ depth: d, units });
  }

  // â”€â”€ Calculate positions â”€â”€
  // Each unit (couple or single) gets a horizontal position
  // Width of a unit = couple: 2*CARD_W + COUPLE_GAP, single: CARD_W
  const nodes = [];
  const lines = [];
  const unitPositions = {}; // unitIndex -> { cx, cy, memberIds }

  let totalW = 0;
  gens.forEach(gen => {
    let genW = 0;
    gen.units.forEach(unit => {
      genW += (unit.length === 2 ? 2*CARD_W + COUPLE_GAP : CARD_W) + SIBLING_GAP;
    });
    genW -= SIBLING_GAP; // remove trailing gap
    totalW = Math.max(totalW, genW);
  });

  const canvasW = totalW + PADDING * 2;

  gens.forEach((gen, gi) => {
    const y = PADDING + gi * (CARD_H + GEN_GAP);
    let genW = 0;
    gen.units.forEach(unit => {
      genW += (unit.length === 2 ? 2*CARD_W + COUPLE_GAP : CARD_W) + SIBLING_GAP;
    });
    genW -= SIBLING_GAP;
    let x = (canvasW - genW) / 2;

    gen.units.forEach((unit, ui) => {
      const unitW = unit.length === 2 ? 2*CARD_W + COUPLE_GAP : CARD_W;
      const cx = x + unitW / 2;

      if (unit.length === 2) {
        const x1 = x, x2 = x + CARD_W + COUPLE_GAP;
        nodes.push({ id: unit[0].id, x: x1, y });
        nodes.push({ id: unit[1].id, x: x2, y });
        // Spouse line
        const lineY = y + 38;
        lines.push({ x1: x1 + CARD_W/2, y1: lineY, x2: x2 + CARD_W/2, y2: lineY });
        unitPositions[`${gi}-${ui}`] = { cx, cy: y, memberIds: [unit[0].id, unit[1].id] };
      } else {
        nodes.push({ id: unit[0].id, x, y });
        unitPositions[`${gi}-${ui}`] = { cx: x + CARD_W/2, cy: y, memberIds: [unit[0].id] };
      }

      x += unitW + SIBLING_GAP;
    });
  });

  // â”€â”€ Draw parent-child lines â”€â”€
  gens.forEach((gen, gi) => {
    gen.units.forEach((unit, ui) => {
      const parentIds = unit.map(m => m.id);
      const allChildIds = new Set();
      parentIds.forEach(pid => (childrenOf[pid]||[]).forEach(cid => allChildIds.add(cid)));
      if (!allChildIds.size) return;

      const parentPos = unitPositions[`${gi}-${ui}`];
      if (!parentPos) return;
      const parentBottomY = parentPos.cy + CARD_H - 20;
      const parentCx = parentPos.cx;

      // Find child nodes
      const childNodes = [...allChildIds].map(cid => nodes.find(n => n.id === cid)).filter(Boolean);
      if (!childNodes.length) return;

      const childTopY = Math.min(...childNodes.map(n => n.y));
      const midY = parentBottomY + (childTopY - parentBottomY) / 2;

      // Vertical from parent center down
      lines.push({ x1: parentCx, y1: parentBottomY, x2: parentCx, y2: midY });

      // Find child center-x positions (center of their card)
      const childCxs = childNodes.map(n => n.x + CARD_W / 2).sort((a,b) => a - b);

      if (childCxs.length === 1) {
        lines.push({ x1: parentCx, y1: midY, x2: childCxs[0], y2: midY });
        lines.push({ x1: childCxs[0], y1: midY, x2: childCxs[0], y2: childTopY });
      } else {
        // Horizontal bar
        lines.push({ x1: childCxs[0], y1: midY, x2: childCxs[childCxs.length-1], y2: midY });
        // Connect parent drop to bar
        if (parentCx < childCxs[0] || parentCx > childCxs[childCxs.length-1]) {
          lines.push({ x1: parentCx, y1: midY, x2: parentCx < childCxs[0] ? childCxs[0] : childCxs[childCxs.length-1], y2: midY });
        }
        // Vertical drops to each child
        childCxs.forEach(cx => {
          lines.push({ x1: cx, y1: midY, x2: cx, y2: childTopY });
        });
      }
    });
  });

  // â”€â”€ Generation labels â”€â”€
  const genLabels = [];
  const n = gens.length;
  gens.forEach((gen, gi) => {
    const fromBottom = n - 1 - gi;
    let label = '';
    if (n > 1) {
      if (fromBottom === 0) label = 'Children';
      else if (fromBottom === 1) label = 'Parents';
      else if (fromBottom === 2) label = 'Grandparents';
      else label = 'Great-'.repeat(fromBottom - 2) + 'Grandparents';
    }
    if (label) {
      const y = PADDING + gi * (CARD_H + GEN_GAP) - 16;
      genLabels.push({ text: label, x: canvasW / 2 - label.length * 3.5, y });
    }
  });

  const totalH = PADDING * 2 + gens.length * CARD_H + (gens.length - 1) * GEN_GAP;

  return { nodes, lines, width: canvasW, height: totalH, genLabels };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAMPLE DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSampleData() {
  document.getElementById('dropdownMenu').classList.remove('show');
  if(familyData.members.length>0 && !confirm('Replace current tree with sample data?')) return;
  const s={settings:{title:'Our Family Tree',subtitle:'The Anderson & Brown Family'},members:[
    {id:'gf1',firstName:'Betty',lastName:'Brown',gender:'female',birthDate:'1945-03-12',photoUrl:'',bio:'Matriarch'},
    {id:'gm1',firstName:'Ron',lastName:'Anderson',gender:'male',birthDate:'1943-07-20',photoUrl:'',bio:'Patriarch'},
    {id:'p2',firstName:'Jace',lastName:'Anderson',gender:'male',birthDate:'1970-02-14',photoUrl:''},
    {id:'p3',firstName:'Alyssa',lastName:'Anderson',maidenName:'Lewis',gender:'female',birthDate:'1972-09-30'},
    {id:'p4',firstName:'Aaron',lastName:'Lewis',gender:'male',birthDate:'1940-01-18',deathDate:'2015-12-01'},
    {id:'c1',firstName:'Jessie',lastName:'Anderson',gender:'female',birthDate:'1995-06-22'},
    {id:'c2',firstName:'Evan',lastName:'Anderson',gender:'male',birthDate:'1997-03-10'},
    {id:'c3',firstName:'Ginger',lastName:'Anderson',gender:'female',birthDate:'2000-12-25'},
    {id:'c4',firstName:'Christian',lastName:'Lewis',gender:'male',birthDate:'1998-08-15'},
    {id:'c5',firstName:'Maria',lastName:'Lewis',gender:'female',birthDate:'2001-04-02'}
  ],relationships:[
    {id:'r1',type:'spouse',person1:'gf1',person2:'gm1'},
    {id:'r3',type:'parent-child',person1:'gf1',person2:'p2'},{id:'r4',type:'parent-child',person1:'gm1',person2:'p2'},
    {id:'r5',type:'parent-child',person1:'gm1',person2:'p3'},{id:'r6',type:'parent-child',person1:'gf1',person2:'p3'},
    {id:'r7',type:'spouse',person1:'p3',person2:'p4'},
    {id:'r8',type:'parent-child',person1:'p2',person2:'c1'},{id:'r9',type:'parent-child',person1:'p2',person2:'c2'},
    {id:'r10',type:'parent-child',person1:'p2',person2:'c3'},
    {id:'r11',type:'parent-child',person1:'p3',person2:'c4'},{id:'r12',type:'parent-child',person1:'p4',person2:'c4'},
    {id:'r13',type:'parent-child',person1:'p3',person2:'c5'},{id:'r14',type:'parent-child',person1:'p4',person2:'c5'}
  ]};
  await api('POST','/import',s); showToast('Sample loaded'); await loadFamily();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
loadFamily();
document.addEventListener('keydown',e=>{ if(e.key==='Escape'){closeMemberModal();closeRelModal();closeSettings();closeDetailPanel();}});
document.querySelectorAll('.modal-overlay').forEach(el=>el.addEventListener('click',e=>{if(e.target===el) el.classList.remove('active');}));
window.addEventListener('resize', () => { if(familyData.members.length) renderTree(); });
</script>
</body>
</html>
